rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Users can read and update their own user document.
    // They cannot change their role once it has been set.
    match /users/{userId} {
      // Allow reading own profile OR reading any 'seeker' profile (for employers)
      allow read: if request.auth != null && (request.auth.uid == userId || resource.data.role == 'seeker');

      // Allow creation of a user document with strict validation
      allow create: if request.auth != null
                    && request.auth.uid == userId
                    && request.resource.data.keys().hasOnly([
                      'uid',
                      'email',
                      'displayName',
                      'photoURL',
                      'role',
                      'last_login',
                      'created_at',
                      'updated_at',
                      // Activity tracking
                      'status',
                      'lastActiveAt',
                      'expiresAt'
                    ])
                    && request.resource.data.uid == request.auth.uid
                    && request.resource.data.email == request.auth.token.email
                    && (
                      request.resource.data.role == null
                      || request.resource.data.role in ['seeker', 'employer']
                    );

      // Only allow safe user-controlled fields to change; role is immutable once set
      allow update: if request.auth != null
                    && request.auth.uid == userId
                    && request.resource.data.diff(resource.data).changedKeys().hasOnly([
                      'displayName',
                      'photoURL',
                      'last_login',
                      'updated_at',
                      'skills',
                      'parsed_data',
                      'embedding',
                      // Activity tracking
                      'status',
                      'lastActiveAt',
                      'expiresAt'
                    ])
                    && (resource.data.role == null
                        || !('role' in request.resource.data)
                        || request.resource.data.role == resource.data.role)
                    && ( !('embedding' in request.resource.data)
                         || (request.resource.data.embedding is list
                             && request.resource.data.embedding.size() == 768
                             && request.resource.data.embedding[0] is number
                             && request.resource.data.embedding[767] is number) )
                    // Validate expiresAt if present (max 4 days + 1 hour buffer)
                    && ( !('expiresAt' in request.resource.data)
                         || request.resource.data.expiresAt <= request.time + duration.value(4, 'd') + duration.value(1, 'h') );
    }

    // Jobs Collection
    match /jobs/{jobId} {
      // Allow public read access to ACTIVE jobs.
      // Employers can read their own non-active jobs.
      allow read: if resource.data.status in ['active', 'passive'] 
                  || (request.auth != null && resource.data.employer_id == request.auth.uid);

      allow create: if request.auth != null
                    && exists(/databases/$(database)/documents/users/$(request.auth.uid))
                    && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'employer'
                    && request.resource.data.employer_id == request.auth.uid
                    && request.resource.data.keys().hasOnly([
                      'employer_id',
                      'title',
                      'description',
                      'skills',
                      'location',
                      'type',
                      'work_mode',
                      'salary_range',
                      'contactEmail',
                      'status',
                      'created_at',
                      'updated_at',
                      'embedding',
                      // Activity tracking
                      'lastActiveAt',
                      'expiresAt',
                      'experience',
                      'screening_questions',
                      'company_id'
                    ])
                    && ( !('embedding' in request.resource.data)
                         || (request.resource.data.embedding is list
                             && request.resource.data.embedding.size() == 768
                             && request.resource.data.embedding[0] is number
                             && request.resource.data.embedding[767] is number) );

      // Only the job owner (employer) can update the job
      allow update: if request.auth != null
                    && resource.data.employer_id == request.auth.uid
                    // restrict what can change
                    && request.resource.data.diff(resource.data).changedKeys().hasOnly([
                      'title',
                      'description',
                      'skills',
                      'location',
                      'type',
                      'work_mode',
                      'salary_range',
                      'contactEmail',
                      'status',
                      'updated_at',
                      'embedding',
                      // Activity tracking
                      'lastActiveAt',
                      'expiresAt',
                      'experience',
                      'screening_questions',
                      'company_id'
                    ])
                    // employer_id is immutable
                    && ( !('employer_id' in request.resource.data)
                         || request.resource.data.employer_id == resource.data.employer_id )
                    // optional: validate status values if you use them
                    && ( !('status' in request.resource.data)
                         || request.resource.data.status in ['active', 'passive', 'closed'] )
                    // validate embedding shape if present
                    && ( !('embedding' in request.resource.data)
                         || (request.resource.data.embedding is list
                             && request.resource.data.embedding.size() == 768
                             && request.resource.data.embedding[0] is number
                             && request.resource.data.embedding[767] is number) )
                    // Validate expiresAt if present (max 4 days + 1 hour buffer)
                    && ( !('expiresAt' in request.resource.data)
                         || request.resource.data.expiresAt <= request.time + duration.value(4, 'd') + duration.value(1, 'h') );
    }

    // Applications Collection
    match /applications/{appId} {
      allow create: if request.auth != null
                    && exists(/databases/$(database)/documents/users/$(request.auth.uid))
                    && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'seeker'
                    // prevent arbitrary field injection
                    && request.resource.data.keys().hasOnly([
                      'candidate_id',
                      'job_id',
                      'employer_id',
                      'answers',
                      'match_score',
                      'status',
                      'applied_at',
                      'updated_at'
                    ])
                    // bind application to caller
                    && request.resource.data.candidate_id == request.auth.uid
                    // job must exist
                    && exists(/databases/$(database)/documents/jobs/$(request.resource.data.job_id));

      allow update: if request.auth != null
                    && get(/databases/$(database)/documents/jobs/$(resource.data.job_id)).data.employer_id == request.auth.uid
                    && request.resource.data.diff(resource.data).changedKeys().hasOnly(['status', 'updated_at']);

      allow read: if request.auth != null
                  && (
                    resource.data.candidate_id == request.auth.uid
                    || get(/databases/$(database)/documents/jobs/$(resource.data.job_id)).data.employer_id == request.auth.uid
                  );
    }

    // Companies Collection
    match /companies/{companyId} {
      // Allow public read access so candidates can view company profiles
      allow read: if true;

      // Allow creation by authenticated employers
      allow create: if request.auth != null
                    && exists(/databases/$(database)/documents/users/$(request.auth.uid))
                    && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'employer'
                    && request.resource.data.employer_ids.hasAll([request.auth.uid]);

      // Allow updates by employers associated with the company.
      // Require that the caller is still an employer and prevent changes to employer_ids
      allow update: if request.auth != null
                    && exists(/databases/$(database)/documents/users/$(request.auth.uid))
                    && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'employer'
                    && resource.data.employer_ids.hasAny([request.auth.uid])
                    && request.resource.data.employer_ids == resource.data.employer_ids;
    }
  }
}
