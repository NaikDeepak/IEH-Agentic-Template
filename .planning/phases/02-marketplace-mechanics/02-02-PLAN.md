---
phase: 02-marketplace-mechanics
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified: [functions/index.js, functions/package.json]
autonomous: true
must_haves:
  truths:
    - "Jobs older than 4 days automatically switch to passive"
    - "Users older than 4 days automatically switch to passive"
  artifacts:
    - path: "functions/index.js"
      provides: "Scheduled Cloud Function (The Reaper)"
  key_links:
    - from: "functions/index.js"
      to: "Firestore (jobs collection)"
      via: "admin-sdk query"
---

<objective>
Implement "The Reaper" - a scheduled Cloud Function that identifies and demotes expired jobs and user profiles.

Purpose: Enforces the "Active Ecosystem" by automating the transition to passive status.
Output: Deployed Cloud Function.
</objective>

<execution_context>
@/Users/deepaknaik/.claude/get-shit-done/workflows/execute-plan.md
@/Users/deepaknaik/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-marketplace-mechanics/02-RESEARCH.md
@functions/index.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Setup Scheduler Dependencies</name>
  <files>functions/package.json</files>
  <action>
    Install `firebase-functions` (v2) if not already fully set up for scheduling.
    Ensure `@google-cloud/firestore` or `firebase-admin` is ready.
    (Existing package.json has firebase-functions ^7.0.3, so likely just verification).
  </action>
  <verify>
    npm list firebase-functions --prefix functions
  </verify>
  <done>
    Dependencies ready.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Reaper Logic</name>
  <files>functions/index.js</files>
  <action>
    Add a new export `reaper` (or similar name) using `onSchedule` (from `firebase-functions/v2/scheduler`).

    Logic:
    1. Run every 24 hours (e.g., "every 24 hours").
    2. Query `jobs` where `status == 'active'` AND `expiresAt < now()`.
    3. Batch update these docs to `status = 'passive'`.
    4. Query `users` where `status == 'active'` AND `expiresAt < now()`.
    5. Batch update these docs to `status = 'passive'`.

    Log the count of items demoted.
  </action>
  <verify>
    grep "onSchedule" functions/index.js
  </verify>
  <done>
    Function exported and contains batch update logic.
  </done>
</task>

</tasks>

<verification>
Since we cannot deploy to real Firebase in this environment, verification is "Code compiles and follows patterns".
</verification>

<success_criteria>
- [ ] Scheduler function defined
- [ ] Query correctly targets expired active items
- [ ] Batch updates used for efficiency
</success_criteria>

<output>
After completion, create `.planning/phases/02-marketplace-mechanics/02-02-SUMMARY.md`
</output>
