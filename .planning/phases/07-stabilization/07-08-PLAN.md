# Plan: 07-08 — API Security Headers & Input Validation

## Goal
Harden the Express API with security headers (Helmet), consistent input validation, and production-safe CORS configuration.

## Proposed Changes

### 1. Helmet Integration
- Install `helmet` in `functions/package.json`.
- Add `app.use(helmet())` in `functions/index.js` before routes.
- Configure Content Security Policy (CSP) appropriate for the API.

### 2. CORS Production Lock-Down
- Remove the `if (!origin) return callback(null, true)` escape hatch — no-origin requests should be denied in production.
- Add `localhost:5173` only when `NODE_ENV !== 'production'`.
- Review `allowedOrigins` list for accuracy.

### 3. Rate Limiting Expansion
- Extend rate limiter to cover `/api/user/*` and `/api/growth/*` routes (currently only AI endpoints).
- Add a stricter limiter for auth-sensitive routes (e.g., `/api/user/verify-phone`: 5 requests/15min).

### 4. Input Validation Library
- Install `zod` in `functions/package.json`.
- Create `functions/src/validators/` with schemas for each handler's expected body.
- Apply validation middleware to all POST routes.
- Return structured 400 errors with field-level messages.

### 5. Sentry Production Tuning
- Reduce `tracesSampleRate` from `1.0` to `0.2` in production (both client and server).
- Keep `1.0` in development for full visibility.

## Verification Plan
1. Curl the API without `Origin` header — request rejected (not allowed by CORS).
2. Send malformed JSON body to each endpoint — returns 400 with validation error.
3. Check response headers for `X-Content-Type-Options`, `Strict-Transport-Security`, etc.
4. Rate limit test: send 6 requests to `/api/user/verify-phone` in 15 min — 6th is rejected.
