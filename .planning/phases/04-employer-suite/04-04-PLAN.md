---
phase: 04-employer-suite
plan: 04
type: execute
wave: 1
depends_on: []
files_modified: [src/features/companies/services/companyService.ts, src/features/jobs/services/jobService.ts, functions/index.js, vite.config.ts]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Application loads in browser without Uncaught SyntaxError: Company"
    - "AI Screening Question generation handles markdown-wrapped JSON from Gemini"
    - "Job creation succeeds without 404 on /api/embedding"
  artifacts:
    - path: "functions/index.js"
      provides: "Robust JSON parsing for AI assistant"
    - path: "vite.config.ts"
      provides: "Correct proxy for /api routes"
  key_links:
    - from: "src/features/jobs/services/jobService.ts"
      to: "/api/embedding"
      via: "fetch"
---

<objective>
Resolve critical blockers identified in UAT: ESM syntax errors, AI parsing failures, and API routing mismatches.

Purpose: Restore core functionality for Company Editor and Job Posting.
Output: Working JD generator, screening question generator, and job persistence with embeddings.
</objective>

<execution_context>
@/Users/deepaknaik/.claude/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/04-employer-suite/04-employer-suite-UAT.md
@functions/index.js
@src/features/jobs/services/jobService.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix ESM Interface Imports</name>
  <files>
    - src/features/companies/services/companyService.ts
    - src/features/jobs/services/jobService.ts
  </files>
  <action>
    Ensure all imports of interfaces (Company, JobPosting, etc.) use the 'import type' syntax.
    The browser console reported a SyntaxError because 'Company' was being searched for as a runtime export.
  </action>
  <verify>Run 'npm run build' or check browser console for "does not provide an export named 'Company'" error.</verify>
  <done>Syntax error is resolved and application loads.</done>
</task>

<task type="auto">
  <name>Task 2: Robust AI JSON Parsing in Functions</name>
  <files>functions/index.js</files>
  <action>
    Update 'generateJobAssistHandler' to handle cases where Gemini returns JSON inside markdown code blocks.
    Current regex 'text.match(/\{[\s\S]*\}/)' is a good start but add logging for the 'text' received and ensure the fallback is handled gracefully.
    Also check if GEMINI_API_KEY is correctly sourced from process.env.
  </action>
  <verify>Call the AI generation in the UI or via curl to ensure it returns valid JSON even if Gemini wraps it in markdown.</verify>
  <done>Screening questions populate reliably in the Job Posting UI.</done>
</task>

<task type="auto">
  <name>Task 3: Resolve /api/embedding 404</name>
  <files>
    - vite.config.ts
    - src/features/jobs/services/jobService.ts
  </files>
  <action>
    The frontend calls '/api/embedding' but receives a 404.
    1. Check vite.config.ts proxy: 'target' should match the local Express/Functions port (usually 8001 based on vite.config.ts).
    2. Check 'functions/index.js' to ensure 'app.post("/api/embedding", ...)' is correctly defined (it appears to be, but verify).
    3. If the local server (index.js) isn't running on 8001, update proxy or start command.
  </action>
  <verify>Submit the Job Posting form. Success means embedding was generated and job was saved.</verify>
  <done>Job postings are created successfully with 1536-dimensional vectors.</done>
</task>

</tasks>

<verification>
- Navigate to /employer/company: No syntax errors in console.
- Navigate to /post-job: Generate questions works.
- Submit job: Creation succeeds.
</verification>

<success_criteria>
- 0 syntax errors on load.
- /api/embedding returns 200.
- AI assistant returns valid screening questions object.
</success_criteria>

<output>
After completion, create `.planning/phases/04-employer-suite/04-04-SUMMARY.md`
</output>
