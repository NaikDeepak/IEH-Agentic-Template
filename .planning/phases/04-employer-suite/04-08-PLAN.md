---
phase: 04-employer-suite
plan: 08
type: execute
wave: 3
depends_on: [04-07]
files_modified: [src/pages/PostJob.tsx, functions/index.js, src/features/jobs/services/jobService.ts]
autonomous: true
gap_closure: true
must_haves:
  truths:
    - "AI Auto-Fill and Suggest Questions work without errors"
    - "Job creation succeeds with valid embeddings"
  artifacts:
    - path: "src/pages/PostJob.tsx"
      provides: "Robust form data handling for AI endpoints"
    - path: "functions/index.js"
      provides: "Regex-based JSON extraction and confirmed 1536d embeddings"
---

<objective>
Resolve critical UAT failures in Phase 4:
1. Fix AI Job Posting tools failure (Missing fields error) by ensuring frontend sends valid default values and backend parses JSON robustly.
2. Fix Job Creation failure (Invalid vector) by aligning embedding dimensions and adding diagnostics.
</objective>

<execution_context>
@/Users/deepaknaik/.claude/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/phases/04-employer-suite/04-UAT.md
@src/pages/PostJob.tsx
@functions/index.js
@src/features/jobs/services/jobService.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix AI Tools Frontend Data Handling</name>
  <files>src/pages/PostJob.tsx</files>
  <action>
    - Update `handleAiGenerateJd` in `PostJob.tsx` to ensure `skills` and `experience` are never `undefined` in the payload (use `|| ""` or `|| []`).
    - Currently `skills: formData.skills || undefined` causes the key to be dropped by JSON.stringify, triggering "Missing required fields" on backend if backend checks keys.
    - Ensure `experience` is passed correctly (it is hardcoded to "relevant experience" currently, which is fine, but double check).
  </action>
  <verify>Manual verification: Click Auto-Fill with only Title entered.</verify>
  <done>Frontend sends complete JSON payload even for optional fields.</done>
</task>

<task type="auto">
  <name>Task 2: Robustify Backend JSON Parsing</name>
  <files>functions/index.js</files>
  <action>
    - In `generateJdHandler` and `generateJobAssistHandler`, update the JSON parsing logic.
    - Use regex `match(/\{[\s\S]*\}/)` to extract the JSON object from the LLM response BEFORE `JSON.parse`.
    - This handles cases where Gemini wraps output in Markdown code blocks (```json ... ```).
  </action>
  <verify>Deploy functions and test with curl or UI.</verify>
  <done>Backend correctly parses Markdown-wrapped JSON responses from Gemini.</done>
</task>

<task type="auto">
  <name>Task 3: Resolve Embedding Dimension Mismatch</name>
  <files>src/features/jobs/services/jobService.ts, functions/index.js</files>
  <action>
    - In `functions/index.js`, ensure `outputDimensionality: 1536` is correctly applied in `embeddingHandler`.
    - In `jobService.ts`, update `fetchEmbedding` to log the received length if validation fails, to aid debugging.
    - If `text-embedding-004` refuses 1536 in the current environment (e.g. model variation), we may need to accept 768 and pad, OR strictly enforce the model version.
    - For now, ensure backend explicitly requests 1536 and frontend reports the actual length received in the error message.
  </action>
  <verify>Submit a job and check if it succeeds or logs specific length mismatch.</verify>
  <done>Job creation succeeds or reports specific dimension error.</done>
</task>

</tasks>

<verification>
1. Go to Post Job page.
2. Enter "Software Engineer".
3. Click "Auto-Fill" -> Should work (no "Missing fields" error).
4. Click "Suggest Questions" -> Should work (no JSON error).
5. Fill rest of form and Submit -> Should redirect to Jobs list (no "Invalid vector" error).
</verification>

<success_criteria>
- [ ] AI Auto-Fill works with just Title
- [ ] AI Suggest Questions works
- [ ] Job Creation persists job to Firestore with valid embedding
</success_criteria>

<output>
After completion, create `.planning/phases/04-employer-suite/04-08-SUMMARY.md`
</output>
