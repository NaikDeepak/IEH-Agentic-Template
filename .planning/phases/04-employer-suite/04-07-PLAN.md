---
phase: 04-employer-suite
plan: 07
type: execute
wave: 2
depends_on: [04-06]
files_modified: [functions/index.js, src/features/applications/components/KanbanColumn.tsx, src/features/applications/components/ApplicantCard.tsx, src/lib/firebase.ts, tests/functions.test.ts]
autonomous: true
gap_closure: true
must_haves:
  truths:
    - "Job creation successfully generates and saves embeddings"
    - "ATS Kanban cards are draggable across columns"
    - "Build passes without unused import warnings in firebase.ts"
  artifacts:
    - path: "functions/index.js"
      provides: "Robust /api/ai/embedding endpoint"
    - path: "src/features/applications/components/ApplicantCard.tsx"
      provides: "Sortable Kanban card implementation"
    - path: "src/lib/firebase.ts"
      provides: "Clean firebase initialization"
---

<objective>
Finalize Phase 4 by closing remaining technical gaps: resolve a critical routing mismatch and parsing fragility for embeddings, ensure ATS Kanban drag-and-drop functionality is robust by refactoring to sortable components, and clear build-blocking warnings and test failures.
</objective>

<execution_context>
@/Users/deepaknaik/.claude/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/04-employer-suite/04-UAT.md
@functions/index.js
@src/features/jobs/services/jobService.ts
@src/features/applications/components/KanbanColumn.tsx
@src/features/applications/components/ApplicantCard.tsx
@src/lib/firebase.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Resolve Embedding Route Mismatch & JSON Fragility</name>
  <files>functions/index.js</files>
  <action>
    - Add `app.post("/api/ai/embedding", embeddingHandler)` to `functions/index.js` to match the path used by `JobService.ts`.
    - Retain existing `/embedding` and `/api/embedding` routes for backward compatibility.
    - Implement regex-based JSON extraction in AI response handling to safely handle markdown blocks and prevent parsing failures (UAT Gap 1).
  </action>
  <verify>curl -X POST http://localhost:8001/api/ai/embedding -H "Content-Type: application/json" -d '{"text": "test"}'</verify>
  <done>Cloud Function responds correctly and handles non-standard AI output formats.</done>
</task>

<task type="auto">
  <name>Task 2: Refactor ATS Kanban to useSortable</name>
  <files>src/features/applications/components/KanbanColumn.tsx, src/features/applications/components/ApplicantCard.tsx</files>
  <action>
    - Refactor `ApplicantCard.tsx` to use `useSortable` from `@dnd-kit/sortable` instead of `useDraggable`.
    - Update `KanbanColumn.tsx` to ensure `SortableContext` receives a flat array of IDs (`application.id`) rather than the objects themselves.
    - Ensure `verticalListSortingStrategy` is correctly applied.
    - Ensure stable keys and IDs are used across both components for robust drag-and-drop behavior.
  </action>
  <verify>Manual verification of Kanban drag-and-drop behavior with seeded data; ensure no "missing items" warnings in console.</verify>
  <done>Kanban board correctly handles drag-and-drop state updates using sortable logic.</done>
</task>

<task type="auto">
  <name>Task 3: Clear Build Blockers & Test Failures</name>
  <files>src/lib/firebase.ts, tests/functions.test.ts</files>
  <action>
    - Remove unused imports from `src/lib/firebase.ts` (specifically any imports flagged as unused in strict mode).
    - Fix type issues in `tests/functions.test.ts` or add necessary `@ts-ignore` comments for environment-specific mismatches that prevent the build.
  </action>
  <verify>Run `npm run build` and ensure zero errors and minimal warnings.</verify>
  <done>Codebase build is clean and ready for Phase 5.</done>
</task>

</tasks>

<verification>
Verify that creating a job no longer fails with a 404 or JSON parsing error. Verify that applications can be dragged between columns on the ATS board using sortable interactions. Verify that the build command completes successfully.
</verification>

<success_criteria>
- Backend supports /api/ai/embedding and handles markdown-wrapped JSON.
- ATS Kanban columns and cards use `@dnd-kit/sortable` with stable IDs.
- build warnings/errors in firebase.ts are resolved.
</success_criteria>

<output>
After completion, create `.planning/phases/04-employer-suite/04-07-SUMMARY.md`
</output>
