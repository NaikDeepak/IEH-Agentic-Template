---
phase: 04-employer-suite
plan: 07
type: execute
wave: 1
depends_on: [04-06]
files_modified: [functions/index.js, src/features/applications/components/KanbanColumn.tsx, src/lib/firebase.ts, tests/functions.test.ts]
autonomous: true
gap_closure: true
must_haves:
  truths:
    - "Job creation successfully generates and saves embeddings"
    - "ATS Kanban cards are draggable across columns"
    - "Build passes without unused import warnings in firebase.ts"
  artifacts:
    - path: "functions/index.js"
      provides: "Correct /api/ai/embedding endpoint"
    - path: "src/lib/firebase.ts"
      provides: "Clean firebase initialization"
---

<objective>
Finalize Phase 4 by closing remaining technical gaps: resolve a critical routing mismatch for embeddings, ensure ATS Kanban drag-and-drop functionality is robust, and clear build-blocking warnings and test failures.
</objective>

<execution_context>
@/Users/deepaknaik/.claude/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/04-employer-suite/04-UAT.md
@functions/index.js
@src/features/jobs/services/jobService.ts
@src/features/applications/components/KanbanColumn.tsx
@src/lib/firebase.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Resolve Embedding Route Mismatch</name>
  <files>functions/index.js</files>
  <action>
    - Add `app.post("/api/ai/embedding", embeddingHandler)` to `functions/index.js` to match the path used by `JobService.ts`.
    - Retain existing `/embedding` and `/api/embedding` routes for backward compatibility.
  </action>
  <verify>curl -X POST http://localhost:8001/api/ai/embedding -H "Content-Type: application/json" -d '{"text": "test"}'</verify>
  <done>Cloud Function responds correctly to the standardized frontend request path.</done>
</task>

<task type="auto">
  <name>Task 2: Fix ATS Kanban Logic and Column ID extraction</name>
  <files>src/features/applications/components/KanbanColumn.tsx</files>
  <action>
    - Update `KanbanColumn.tsx` to ensure `SortableContext` receives a flat array of IDs (`application.id`) rather than the objects themselves.
    - Ensure `verticalListSortingStrategy` is correctly applied.
    - Verify that the `useSortable` hook in `ApplicantCard.tsx` (which we saw uses `application.id`) matches the IDs provided here.
  </action>
  <verify>Manual verification of Kanban drag-and-drop behavior with seeded data.</verify>
  <done>Kanban board correctly handles drag-and-drop state updates.</done>
</task>

<task type="auto">
  <name>Task 3: Clear Build Blockers & Test Failures</name>
  <files>src/lib/firebase.ts, tests/functions.test.ts</files>
  <action>
    - Remove unused imports from `src/lib/firebase.ts` (specifically any imports flagged as unused in strict mode).
    - Fix type issues in `tests/functions.test.ts` or add necessary `@ts-ignore` comments for environment-specific mismatches that prevent the build.
  </action>
  <verify>Run `npm run build` and ensure zero errors and minimal warnings.</verify>
  <done>Codebase build is clean and ready for Phase 5.</done>
</task>

</tasks>

<verification>
Verify that creating a job no longer fails with a 404. Verify that applications can be dragged between columns on the ATS board. Verify that the build command completes successfully.
</verification>

<success_criteria>
- Backend supports /api/ai/embedding.
- ATS Kanban columns correctly render sortable items with stable IDs.
- build warnings/errors in firebase.ts are resolved.
</success_criteria>

<output>
After completion, create `.planning/phases/04-employer-suite/04-07-SUMMARY.md`
</output>
